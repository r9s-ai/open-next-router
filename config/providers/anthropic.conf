syntax "next-router/0.1";

# Anthropic Claude (upstream /v1/messages)
provider "anthropic" {
  defaults {
    upstream_config {
      base_url = "https://api.anthropic.com";
    }

    # Anthropic uses x-api-key (value comes from the selected upstream key)
    auth {
      auth_header_key "x-api-key";
    }

    # Anthropic API version header (adjust if needed)
    request {
      set_header "anthropic-version" "2023-06-01";
    }

    response {
      resp_passthrough;
    }

    metrics {
      usage_extract anthropic;
    }
  }

  match api = "chat.completions" {
    upstream {
      set_path "/v1/chat/completions";
    }
  }

  match api = "claude.messages" {
    upstream {
      set_path "/v1/messages";
    }
    # Compatibility: some clients send OpenAI-style stream_options; Anthropic /v1/messages rejects it.
    request {
      json_del "$.stream_options";
    }
  }
}
