syntax "next-router/0.1";

provider "openai-oauth" {
  defaults {
    upstream_config {
      base_url = "https://chatgpt.com/backend-api/codex";
    }
    auth {
      # OpenAI OAuth refresh_token mode:
      # - key source: $channel.key (as refresh_token)
      # - token exchange endpoint/client defaults come from oauth_mode openai
      oauth_mode openai;
      oauth_refresh_token $channel.key;
      auth_oauth_bearer;
    }
    response {
      resp_passthrough;
    }
    metrics {
      usage_extract openai;
      finish_reason_extract openai;
    }
  }

  match api = "responses" {
    request {
      json_set_if_absent "$.instructions" "";
      json_set "$.store" false;
    }
    upstream {
      set_path "/responses";
    }
  }
}
