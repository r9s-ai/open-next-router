syntax "next-router/0.1";

provider "gemini" {
  defaults {
    upstream_config {
      # Gemini native base URL
      base_url = "https://generativelanguage.googleapis.com";
    }
    auth {
      auth_header_key "x-goog-api-key";
    }

    metrics {
      usage_extract gemini;
      finish_reason_extract gemini;
    }
    response {
      resp_passthrough;
    }
  }

  # Gemini native API: /v1beta/models/{model}:generateContent
  match api = "gemini.generateContent" {
    upstream {
      set_path concat("/v1beta/models/", $request.model_mapped, ":generateContent");
      # set_query key $channel.key;
    }
  }

  # Gemini native SSE: /v1beta/models/{model}:streamGenerateContent?alt=sse
  match api = "gemini.streamGenerateContent" {
    upstream {
      set_path concat("/v1beta/models/", $request.model_mapped, ":streamGenerateContent");
      set_query alt "sse";
      # set_query key $channel.key;
    }
  }
}
