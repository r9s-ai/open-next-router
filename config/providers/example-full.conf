syntax "next-router/0.1";

# ============================================================
# Full example provider config for DSL v0.1.
#
# Conventions:
# - The filename MUST match the provider name:
#     config/providers/example-full.conf <-> provider "example-full"
# - Provider name is normalized to lowercase for matching.
# - base_url here is the default. You can override it per-key in keys.yaml via
#   providers.<name>.keys[].base_url_override.
# - Auth header MUST be declared in conf, but the token/value is NOT written
#   here. It always comes from the selected upstream key.
# ============================================================

provider "example-full" {
  defaults {
    # upstream_config: default upstream settings (v0.1 only parses base_url)
    upstream_config {
      # base_url: required; default upstream base URL (string literal)
      base_url = "https://api.example.com";
    }

    # auth: auth phase
    auth {
      # auth_bearer: Authorization: Bearer <upstream_key>
      auth_bearer;

      # auth_header_key: <name>: <upstream_key>
      # Examples:
      # auth_header_key "api-key";   # Azure OpenAI style
      # auth_header_key "x-api-key"; # Anthropic style
    }

    # request: request phase (headers + lightweight JSON ops + model mapping)
    request {
      # set_header: set/override a request header
      # Syntax: set_header <Header-Name> <expr>;
      set_header "x-example" "1";

      # del_header: delete a request header
      # Syntax: del_header <Header-Name>;
      del_header "x-remove-me";

      # model_map: map $request.model -> $request.model_mapped
      # Syntax:
      #   model_map <from-model> <expr>;
      #   model_map_default <expr>;
      #
      # Examples:
      # model_map "gpt-4o-mini" "my-deployment-name";
      # model_map_default $request.model;

      # json_set/json_del/json_rename: apply lightweight JSON transforms on the
      # generated upstream request body.
      #
      # Syntax:
      #   json_set <jsonpath> <expr>;
      #   json_del <jsonpath>;
      #   json_rename <from-jsonpath> <to-jsonpath>;
      #
      # Notes:
      # - JSONPath (v0.1) only supports object paths: $.a.b.c (no array indexes)
      #
      # Examples:
      # json_set "$.stream" true;
      # json_rename "$.max_tokens" "$.max_completion_tokens";
      # json_del "$.tools";
    }

    # response: response phase (v0.1 supported by next-router; open-next-router
    # MVP currently proxies streaming as-is).
    # response { resp_passthrough; }
    # response { resp_map anthropic_to_openai_chat; }
    # response { sse_parse anthropic_to_openai_chunks; }

    # metrics: metrics phase (v0.1 supports usage_extract)
    # metrics { usage_extract openai; }
    #
    # custom example (assignments support + / -; missing values are treated as 0):
    # metrics {
    #   usage_extract custom;
    #   input_tokens = $.usage.prompt_tokens + $.usage.input_tokens;
    #   output_tokens = $.usage.output_tokens;
    #   cache_read_tokens = $.usage.cache_read_input_tokens;
    #   cache_write_tokens = $.usage.cache_creation_input_tokens;
    #   total_tokens = $.usage.total_tokens - $.usage.cached_tokens;
    # }
    #
    # custom short form (single JSONPath only; no arithmetic):
    # metrics {
    #   usage_extract custom;
    #   input_tokens_path "$.usage.input_tokens";
    #   output_tokens_path "$.usage.output_tokens";
    #   cache_read_tokens_path "$.usage.cache_read_input_tokens";
    #   cache_write_tokens_path "$.usage.cache_creation_input_tokens";
    # }
  }

  # error: error normalization (v0.1 only supports error_map)
  # defaults { error { error_map openai; } }
  # match api = "chat.completions" { error { error_map openai; } }

  # 1) chat.completions (non-stream)
  match api = "chat.completions" stream = false {
    # You can also declare auth/request inside match to override/extend defaults.
    auth {
      auth_header_key "x-api-key";
    }
    request {
      set_header "x-trace-id" "trace-123";
    }

    # upstream: upstream routing (v0.1 supports set_path / set_query / del_query)
    upstream {
      # set_path: set upstream path
      set_path "/v1/chat/completions";
      # Azure style example:
      # set_path concat("/openai/deployments/", $request.model_mapped, "/chat/completions");

      # set_query: set query parameter
      # Syntax: set_query <name> <expr>;
      set_query "api-version" "2024-10-01";

      # del_query: delete query parameter
      # Syntax: del_query <name>;
      # del_query "foo";
    }

    response {
      resp_passthrough;
    }

    metrics {
      usage_extract openai;
    }
  }

  # 2) chat.completions (stream)
  match api = "chat.completions" stream = true {
    upstream {
      set_path "/v1/chat/completions";
      set_query stream "true";
    }
    response {
      resp_passthrough;
    }
  }

  # 3) embeddings
  match api = "embeddings" {
    upstream {
      set_path "/v1/embeddings";
    }
    response {
      resp_passthrough;
    }
  }
}
