syntax "next-router/0.1";

# Azure OpenAI（注意：真实 base_url 需在渠道里配置为你的资源 Endpoint）
provider "azure" {
  defaults {
    # 兜底默认值（必填）。建议在渠道里覆盖为你的 Azure 资源 endpoint：
    #   https://<resource>.openai.azure.com
    upstream_config {
      base_url = "https://example-resource.openai.azure.com";
    }

    # Azure 使用 api-key 头鉴权（value 固定取渠道 key）
    auth {
      auth_header_key "api-key";
    }

    metrics {
      usage_extract openai;
      finish_reason_extract openai;
    }
    error {
      error_map openai;
    }
    response {
      resp_passthrough;
    }
  }

  # 说明：v0.1 暂不支持从渠道 config 读取 api_version；这里使用固定默认值。
  # 如需更改可直接改 conf 并让 relay 重载。

  match api = "chat.completions" {
    upstream {
      set_path concat("/openai/deployments/", $request.model_mapped, "/chat/completions");
      set_query "api-version" "2024-02-15-preview";
    }
  }

  match api = "completions" {
    upstream {
      set_path concat("/openai/deployments/", $request.model_mapped, "/completions");
      set_query "api-version" "2024-02-15-preview";
    }
  }

  match api = "embeddings" {
    upstream {
      set_path concat("/openai/deployments/", $request.model_mapped, "/embeddings");
      set_query "api-version" "2024-02-15-preview";
    }
  }

  match api = "images.generations" {
    upstream {
      set_path concat("/openai/deployments/", $request.model_mapped, "/images/generations");
      set_query "api-version" "2024-02-15-preview";
    }
  }

  match api = "audio.speech" {
    upstream {
      set_path concat("/openai/deployments/", $request.model_mapped, "/audio/speech");
      set_query "api-version" "2024-02-15-preview";
    }
  }

  match api = "audio.transcriptions" {
    upstream {
      set_path concat("/openai/deployments/", $request.model_mapped, "/audio/transcriptions");
      set_query "api-version" "2024-02-15-preview";
    }
  }

  match api = "audio.translations" {
    upstream {
      set_path concat("/openai/deployments/", $request.model_mapped, "/audio/translations");
      set_query "api-version" "2024-02-15-preview";
    }
  }
}
